
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Erfan Zare Chavoshi">
      
      
      
        <link rel="prev" href="../generated-reinforcement_learning-trainer-base/">
      
      
        <link rel="next" href="../generated-reinforcement_learning-trainer-partitioner_config/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.7">
    
    
      
        <title>Dpo Trainer - EasyDel</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reinforcement_learningtrainerdpo_trainer" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EasyDel" class="md-header__button md-logo" aria-label="EasyDel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EasyDel
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dpo Trainer
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/erfanzar/EasyDel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EasyDel" class="md-nav__button md-logo" aria-label="EasyDel" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EasyDel
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/erfanzar/EasyDel" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../AvailableModels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AvailableModels
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CONTRIBUTING
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data Preprocessing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Data Preprocessing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-data_preprocessing-_processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Processor
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Bits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EasyBIT
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Etils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Etils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-etils-auto_tx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Auto Tx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-etils-configs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-etils-easystate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Easystate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-etils-errors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Errors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-etils-etils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Etils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Eval
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Eval
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-eval-lm_eval/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lm Eval
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DataProcessing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DataProcessing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../EasyStateExample/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EasyState
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Falcon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Falcon Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../FineTuningExample/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fine Tuning Example
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../JAXServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JAXServer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Llama/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Llama2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama2 Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../LoRA-TransferLearningExample/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LoRA and Transfer Learning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Mistral/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mistral Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MosaicMPT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MosaicMPT Models
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PyTorchServer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PytorchServer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linen
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Linen
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-linen-bits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-linen-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modules
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-auto_easydel_model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Auto Easydel Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-easy_attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Easy Attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-easydel_modelling_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Easydel Modelling Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Falcon
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            Falcon
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-falcon-falcon_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Falcon Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-falcon-modelling_falcon_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Falcon Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-flax_modelling_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flax Modelling Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_6" >
        
          
          <label class="md-nav__link" for="__nav_10_6" id="__nav_10_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpt J
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_6">
            <span class="md-nav__icon md-icon"></span>
            Gpt J
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt_j-gpt_j_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gpt J Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt_j-modelling_gpt_j_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Gpt J Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_7" >
        
          
          <label class="md-nav__link" for="__nav_10_7" id="__nav_10_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpt Neo X
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7">
            <span class="md-nav__icon md-icon"></span>
            Gpt Neo X
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt_neo_x-gpt_neo_x_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gpt Neo X Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt_neo_x-modelling_gpt_neo_x_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Gpt Neo X Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_8" >
        
          
          <label class="md-nav__link" for="__nav_10_8" id="__nav_10_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpt2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_8">
            <span class="md-nav__icon md-icon"></span>
            Gpt2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt2-gpt2_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gpt2 Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-gpt2-modelling_gpt2_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Gpt2 Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9" >
        
          
          <label class="md-nav__link" for="__nav_10_9" id="__nav_10_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Llama
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_9">
            <span class="md-nav__icon md-icon"></span>
            Llama
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-llama-llama_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-llama-modelling_llama_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Llama Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_10" >
        
          
          <label class="md-nav__link" for="__nav_10_10" id="__nav_10_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Lucid Transformer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_10">
            <span class="md-nav__icon md-icon"></span>
            Lucid Transformer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-lucid_transformer-lt_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lt Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-lucid_transformer-modelling_lt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Lt Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_11" >
        
          
          <label class="md-nav__link" for="__nav_10_11" id="__nav_10_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mamba
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_11">
            <span class="md-nav__icon md-icon"></span>
            Mamba
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mamba-mamba_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mamba Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mamba-modelling_mamba_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Mamba Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_12" >
        
          
          <label class="md-nav__link" for="__nav_10_12" id="__nav_10_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mistral
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_12">
            <span class="md-nav__icon md-icon"></span>
            Mistral
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mistral-mistral_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mistral Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mistral-modelling_mistral_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Mistral Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_13" >
        
          
          <label class="md-nav__link" for="__nav_10_13" id="__nav_10_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mixtral
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_13">
            <span class="md-nav__icon md-icon"></span>
            Mixtral
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mixtral-mixtral_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mixtral Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mixtral-modelling_mixtral_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Mixtral Flax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_14" >
        
          
          <label class="md-nav__link" for="__nav_10_14" id="__nav_10_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mosaic Mpt
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_14">
            <span class="md-nav__icon md-icon"></span>
            Mosaic Mpt
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mosaic_mpt-modelling_mpt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Mpt Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-mosaic_mpt-mosaic_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mosaic Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_15" >
        
          
          <label class="md-nav__link" for="__nav_10_15" id="__nav_10_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Opt
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_15">
            <span class="md-nav__icon md-icon"></span>
            Opt
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-opt-modelling_opt_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Opt Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-opt-opt_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Opt Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_16" >
        
          
          <label class="md-nav__link" for="__nav_10_16" id="__nav_10_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Palm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_16">
            <span class="md-nav__icon md-icon"></span>
            Palm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-palm-modelling_palm_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Palm Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-palm-palm_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Palm Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_17" >
        
          
          <label class="md-nav__link" for="__nav_10_17" id="__nav_10_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Phi
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_17">
            <span class="md-nav__icon md-icon"></span>
            Phi
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-phi-modelling_phi_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Phi Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-phi-phi_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phi Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_18" >
        
          
          <label class="md-nav__link" for="__nav_10_18" id="__nav_10_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Qwen2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_18">
            <span class="md-nav__icon md-icon"></span>
            Qwen2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-qwen2-modelling_qwen_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Qwen Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-qwen2-qwen_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Qwen Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_19" >
        
          
          <label class="md-nav__link" for="__nav_10_19" id="__nav_10_19_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Roberta
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_19_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_19">
            <span class="md-nav__icon md-icon"></span>
            Roberta
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-roberta-modelling_roberta_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Roberta Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-roberta-roberta_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roberta Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_20" >
        
          
          <label class="md-nav__link" for="__nav_10_20" id="__nav_10_20_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    T5
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_20_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_20">
            <span class="md-nav__icon md-icon"></span>
            T5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-t5-modelling_t5_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling T5 Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-modules-t5-t5_configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    T5 Configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Partitioning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Partitioning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-partitioning-partitioner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Partitioner
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" checked>
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reinforcement Learning
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            Reinforcement Learning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_2" >
        
          
          <label class="md-nav__link" for="__nav_12_2" id="__nav_12_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12_2">
            <span class="md-nav__icon md-icon"></span>
            Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-models-modelling_casual_language_rl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling Casual Language Rl
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_3" checked>
        
          
          <label class="md-nav__link" for="__nav_12_3" id="__nav_12_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Trainer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_12_3">
            <span class="md-nav__icon md-icon"></span>
            Trainer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Dpo Trainer
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Dpo Trainer
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer" class="md-nav__link">
    <span class="md-ellipsis">
      dpo_trainer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      DPOTrainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DPOTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.build_tokenized_answer" class="md-nav__link">
    <span class="md-ellipsis">
      build_tokenized_answer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.compute_reference_log_probs" class="md-nav__link">
    <span class="md-ellipsis">
      compute_reference_log_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.eval" class="md-nav__link">
    <span class="md-ellipsis">
      eval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      get_mesh
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_train_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      get_train_dataloader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.tokenize_row" class="md-nav__link">
    <span class="md-ellipsis">
      tokenize_row
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.concatenated_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      concatenated_inputs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_concatenated_forward" class="md-nav__link">
    <span class="md-ellipsis">
      create_concatenated_forward
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_dpo_train_function" class="md-nav__link">
    <span class="md-ellipsis">
      create_dpo_train_function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.get_batch_log_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_batch_log_probs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-partitioner_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Partitioner Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-ppo_config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ppo Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-ppo_trainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ppo Trainer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-training_configs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training Configs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-trainer-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_4" >
        
          
          <label class="md-nav__link" for="__nav_12_4" id="__nav_12_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12_4">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-reinforcement_learning-utils-collectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Collectors
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Serve
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            Serve
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13_1" >
        
          
          <label class="md-nav__link" for="__nav_13_1" id="__nav_13_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Api
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_13_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13_1">
            <span class="md-nav__icon md-icon"></span>
            Api
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-api-client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-api-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-api-dantics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dantics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-api-serve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serve
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-gradio_user_interface_base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gradio User Interface Base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-jax_serve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jax Serve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-torch_serve/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Torch Serve
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-serve-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Smi
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            Smi
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-smi-smi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Smi
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <label class="md-nav__link" for="__nav_15" id="__nav_15_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Trainer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            Trainer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-trainer-base_trainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Base Trainer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-trainer-causal_language_model_trainer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Causal Language Model Trainer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-trainer-training_configurations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Training Configurations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-trainer-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Transform
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            Transform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-easydel_transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Easydel Transform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-falcon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Falcon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-llama/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Llama
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-mistral/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mistral
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-mpt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-transform-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_17" >
        
          
          <label class="md-nav__link" for="__nav_17" id="__nav_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_17">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-utils-checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Checker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-utils-prompters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-utils-tensor_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tensor Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-utils-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    install
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer" class="md-nav__link">
    <span class="md-ellipsis">
      dpo_trainer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      DPOTrainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DPOTrainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      __repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__str__" class="md-nav__link">
    <span class="md-ellipsis">
      __str__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.build_tokenized_answer" class="md-nav__link">
    <span class="md-ellipsis">
      build_tokenized_answer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.compute_reference_log_probs" class="md-nav__link">
    <span class="md-ellipsis">
      compute_reference_log_probs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.eval" class="md-nav__link">
    <span class="md-ellipsis">
      eval
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      get_mesh
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_train_dataloader" class="md-nav__link">
    <span class="md-ellipsis">
      get_train_dataloader
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.tokenize_row" class="md-nav__link">
    <span class="md-ellipsis">
      tokenize_row
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.concatenated_inputs" class="md-nav__link">
    <span class="md-ellipsis">
      concatenated_inputs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_concatenated_forward" class="md-nav__link">
    <span class="md-ellipsis">
      create_concatenated_forward
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_dpo_train_function" class="md-nav__link">
    <span class="md-ellipsis">
      create_dpo_train_function
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.get_batch_log_probs" class="md-nav__link">
    <span class="md-ellipsis">
      get_batch_log_probs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="reinforcement_learningtrainerdpo_trainer">reinforcement_learning.trainer.dpo_trainer</h1>


<div class="doc doc-object doc-module">



<a id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer" class="doc doc-heading">
          <code>DPOTrainer</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>EasyDel DPO Trainer Class</p>

            <details class="quote">
              <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DPOTrainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EasyDel DPO Trainer Class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model_state</span><span class="p">:</span> <span class="n">EasyDelState</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ref_model_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EasyDelState</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">partitioner_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartitionerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">PartitionerConfig</span><span class="p">(),</span>
            <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">label_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">loss_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span> <span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
            <span class="n">arguments</span><span class="p">:</span> <span class="n">TrainArguments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">truncation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PreTrainedTokenizerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_prompt_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_target_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">precompute_ref_log_probs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">model_init_kwarguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">ref_model_init_kwarguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">reference_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The __init__ function is called when the class is instantiated.</span>
<span class="sd">        It sets up the attributes of an object.</span>


<span class="sd">        :param self: Refer to the object itself</span>
<span class="sd">        :param model_state: EasyDelState | str: Pass the model state to the trainer</span>
<span class="sd">        :param ref_model_state: Optional[EasyDelState | str]: Pass the reference model state</span>
<span class="sd">        :param partitioner_config: Optional[PartitionerConfig]: Specify the partitioner configuration</span>
<span class="sd">        :param beta: float: Control the strength of the regularization term</span>
<span class="sd">        :param label_smoothing: float: Smooth the labels</span>
<span class="sd">        :param loss_type: Literal[&quot;sigmoid&quot;, &quot;hinge&quot;, &quot;ipo&quot;, &quot;kto&quot;] : Determine the loss function used</span>
<span class="sd">        :param arguments: TrainArguments: Pass the arguments to the trainer</span>
<span class="sd">        :param label_pad_token_id: int: Pad the labels</span>
<span class="sd">        :param padding_value: int: Specify the value that is used for padding</span>
<span class="sd">        :param truncation_mode: str: Truncate the input text</span>
<span class="sd">        :param train_dataset: Optional[Dataset]: Load the training dataset</span>
<span class="sd">        :param eval_dataset: Optional[Union[Dataset, Dict[str, Dataset]]] : Pass the evaluation dataset to the trainer</span>
<span class="sd">        :param tokenizer: Optional[PreTrainedTokenizerBase]: Pass the tokenizer to the trainer</span>
<span class="sd">        :param max_length: Optional[int]: Set the maximum length of the input sequence</span>
<span class="sd">        :param max_prompt_length: Optional[int]: Set the maximum length of the prompt</span>
<span class="sd">        :param max_target_length: Optional[int]: Truncate the target sequence</span>
<span class="sd">        :param precompute_ref_log_probs: bool: Precompute the log probabilities of the reference model</span>
<span class="sd">        :param model_init_kwarguments: Optional[Dict]: Pass in the model_kwarguments to model for init process</span>
<span class="sd">        :param ref_model_init_kwarguments: Optional[Dict]: Pass the ref_model_init_kwarguments to ref_model for init process</span>
<span class="sd">        :param : Set the padding value for the model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">partitioner_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">partitioner_config</span> <span class="o">=</span> <span class="n">PartitionerConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitioner_config</span> <span class="o">=</span> <span class="n">partitioner_config</span>
        <span class="k">assert</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;You Have to pass arguments that will be used for training but you have passed&quot;</span>
            <span class="s2">&quot;`arguments=None`&quot;</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">TrainArguments</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;arguments type must be `TrainArguments` but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">model_init_kwarguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_init_kwarguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You passed model_kwarguments to the DPOTrainer. But your model is already instantiated.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref_model_init_kwarguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_model_init_kwarguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You passed ref_model_kwarguments to the DPOTrainer. But your ref_model is already instantiated.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You passed a model_id to the DPOTrainer. This will automatically create an &quot;</span>
                <span class="s2">&quot;`AutoEasyDelModelForCausalLM` for you.&quot;</span>
            <span class="p">)</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="n">EasyDelState</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">model_state</span><span class="p">,</span>
                <span class="o">**</span><span class="n">model_init_kwarguments</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You passed a ref model_id to the DPOTrainer. This will automatically create an &quot;</span>
                <span class="s2">&quot;`AutoEasyDelModelForCausalLM`&quot;</span>
            <span class="p">)</span>
            <span class="n">ref_model_state</span> <span class="o">=</span> <span class="n">EasyDelState</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="n">ref_model_state</span><span class="p">,</span>
                <span class="o">**</span><span class="n">ref_model_init_kwarguments</span>
            <span class="p">)</span>

        <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DPODataCollatorWithPadding</span><span class="p">(</span>
            <span class="n">pad_token_id</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding_value</span> <span class="o">=</span> <span class="n">padding_value</span> <span class="k">if</span> <span class="n">padding_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span> <span class="o">=</span> <span class="n">max_prompt_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">=</span> <span class="n">truncation_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span> <span class="o">=</span> <span class="n">max_target_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="o">=</span> <span class="n">precompute_ref_log_probs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_free</span> <span class="o">=</span> <span class="n">reference_free</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">loss_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label_smoothing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;You are using a loss type that does not support label smoothing. Ignoring label_smoothing parameter.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span> <span class="o">=</span> <span class="n">label_smoothing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

        <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepspeed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_in_train</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span> <span class="o">=</span> <span class="n">data_collator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span> <span class="o">=</span> <span class="n">ref_model_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_state</span> <span class="o">=</span> <span class="n">model_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loggers_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_mesh</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span> <span class="o">=</span> <span class="n">create_concatenated_forward</span><span class="p">(</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The _get_train_dataloader function is used to create a DataLoader object for the training dataset.</span>

<span class="sd">        :param self: Represent the instance of the class</span>
<span class="sd">        :return: A dataloader object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trainer: training requires a train_dataset.&quot;</span><span class="p">)</span>

        <span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span>
        <span class="n">data_collator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_remove_unused_columns&quot;</span><span class="p">):</span>
            <span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_unused_columns</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t find function `_remove_unused_columns` if you are the &quot;</span>
                <span class="s2">&quot;developer fix this otherwise ignore this warning&quot;</span>
            <span class="p">)</span>
        <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="n">data_collator</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">train_dataset</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dataloader_params</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_train_dataloader</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the training [`~torch.utils.data.DataLoader`].</span>

<span class="sd">        Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute `ref_log_probs`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span><span class="p">:</span>
            <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span>
                <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
                <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
                <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
                <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">)</span>

            <span class="n">reference_chosen_log_probs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reference_rejected_log_probs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Train dataset reference log probs&quot;</span><span class="p">):</span>
                <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_state</span><span class="p">,</span>
                    <span class="n">padded_batch</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">reference_chosen_log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
                <span class="n">reference_rejected_log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

            <span class="n">all_reference_chosen_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reference_chosen_log_probs</span><span class="p">)</span>
            <span class="n">all_reference_rejected_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reference_rejected_log_probs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_log_probs&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_log_probs</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_log_probs&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_log_probs</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_train_dataloader</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_tokenized_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Llama tokenizer does satisfy `enc(a + b) = enc(a) + enc(b)`.</span>
<span class="sd">        It does ensure `enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">full_tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">answer</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

        <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">):]</span>
        <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">):]</span>
        <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">)</span>
        <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">answer_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">)</span>
        <span class="n">full_concat_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">prompt_input_ids</span><span class="p">,</span>
                <span class="n">answer_input_ids</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Prepare input tokens for token by token comparison</span>
        <span class="n">full_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_concat_input_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and answer input ids should have the same length.&quot;</span><span class="p">)</span>

        <span class="n">response_token_ids_start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prompt_input_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">!=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]:</span>
            <span class="n">response_token_ids_start_idx</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>
        <span class="n">prompt_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_attention_mask</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and attention mask should have the same length.&quot;</span><span class="p">)</span>

        <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>
        <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">prompt_input_ids</span><span class="o">=</span><span class="n">prompt_input_ids</span><span class="p">,</span>
            <span class="n">prompt_attention_mask</span><span class="o">=</span><span class="n">prompt_attention_mask</span><span class="p">,</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">answer_input_ids</span><span class="p">,</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">answer_attention_mask</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">tokenize_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">EasyDelState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The tokenize_row function is responsible for taking a single row of data and converting it into the format that</span>
<span class="sd">        the model expects. This includes:</span>
<span class="sd">        - Tokenizing the text (using HuggingFace&#39;s tokenizer)</span>
<span class="sd">        - Padding/truncating sequences to a fixed length (if necessary)</span>
<span class="sd">        - Creating attention masks, which tell the model which tokens are padding and which aren&#39;t.</span>

<span class="sd">        :param self: Represent the instance of the class</span>
<span class="sd">        :param feature: Pass in the data from the dataset</span>
<span class="sd">        :param state: EasyDelState: Keep track of the state of the tokenizer</span>
<span class="sd">        :return: A dictionary of the following keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
        <span class="n">rejected</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2"> , </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chosen should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span><span class="si">}</span><span class="s2"> , </span><span class="si">{</span><span class="n">chosen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejected should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

        <span class="c1"># add BOS token to head of prompt</span>
        <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>

        <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>

        <span class="c1"># add EOS token to end of answer</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">longer_response_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]))</span>

        <span class="c1"># if combined sequence is too long, truncate the prompt</span>
        <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_start&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                        <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                        <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown truncation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if that&#39;s still too long, truncate the response</span>
        <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]:</span>
                    <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>

        <span class="c1"># Create labels</span>
        <span class="n">chosen_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">rejected_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
        <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
                                                                                     <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
        <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
                                                                                         <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tokens_</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="s2">&quot;chosen_&quot;</span><span class="p">:</span> <span class="n">chosen_sequence_tokens</span><span class="p">,</span>
            <span class="s2">&quot;rejected_&quot;</span><span class="p">:</span> <span class="n">rejected_sequence_tokens</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">prompt_tokens</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">type_key</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">tokens_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">type_key</span> <span class="o">==</span> <span class="s2">&quot;token_type_ids&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">type_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>

        <span class="k">return</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="nf">compute_reference_log_probs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">EasyDelState</span><span class="p">,</span>
            <span class="n">padded_batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
                <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span>
                <span class="n">apply_fn</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">padded_batch</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
                <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
                <span class="n">_</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span>
                <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">batch</span><span class="o">=</span><span class="n">padded_batch</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">reference_chosen_log_probs</span><span class="p">,</span> <span class="n">reference_rejected_log_probs</span>

    <span class="k">def</span> <span class="nf">get_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">Mesh</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The get_mesh function returns the mesh of a given instance of the class.</span>

<span class="sd">        :param self: Bind the method to an object</span>
<span class="sd">        :return: The mesh of the device</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">train_function</span> <span class="o">=</span> <span class="n">create_dpo_train_function</span><span class="p">(</span>
            <span class="n">concatenated_forward</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">,</span>
            <span class="n">ref_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span><span class="p">,</span>
            <span class="n">loss_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span><span class="p">,</span>
            <span class="n">reference_free</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_free</span><span class="p">,</span>
            <span class="n">label_smoothing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">epoch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">num_train_epochs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_train_dataloader</span><span class="p">():</span>
                <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">step_start_point</span> <span class="o">&gt;</span> <span class="n">step</span><span class="p">:</span>
                    <span class="o">...</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model_state</span><span class="p">,</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">train_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_state</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process is Under Progress ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO : Finish Eval Step</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The __repr__ function is used to generate a string representation of an object.</span>
<span class="sd">        This function should return a string that can be parsed by the Python interpreter</span>
<span class="sd">        to recreate the object. The __repr__ function is called when you use print() on an</span>
<span class="sd">        object, or when you type its name in the REPL.</span>

<span class="sd">        :param self: Refer to the instance of the class</span>
<span class="sd">        :return: A string representation of the object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">repr_src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> : &quot;</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">string</span> <span class="o">+=</span> <span class="n">repr_src</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repr_src</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">350</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> : &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(...)&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">string</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The __str__ function is called when you use the print function or when str() is used.</span>
<span class="sd">        It should return a string representation of the object.</span>

<span class="sd">        :param self: Refer to the instance of the class</span>
<span class="sd">        :return: The object&#39;s string representation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">partitioner_config</span><span class="o">=</span><span class="n">PartitionerConfig</span><span class="p">(),</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label_smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">loss_type</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncation_mode</span><span class="o">=</span><span class="s1">&#39;keep_end&#39;</span><span class="p">,</span> <span class="n">train_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eval_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_target_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">precompute_ref_log_probs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_init_kwarguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref_model_init_kwarguments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_free</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The <strong>init</strong> function is called when the class is instantiated.
It sets up the attributes of an object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Refer to the object itself</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>model_state</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lib.python.EasyDel.etils.easystate.EasyDelState" href="../generated-etils-easystate/#lib.python.EasyDel.etils.easystate.EasyDelState">EasyDelState</a> | str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>EasyDelState | str: Pass the model state to the trainer</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ref_model_state</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="lib.python.EasyDel.etils.easystate.EasyDelState" href="../generated-etils-easystate/#lib.python.EasyDel.etils.easystate.EasyDelState">EasyDelState</a> | str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[EasyDelState | str]: Pass the reference model state</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>partitioner_config</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="lib.python.EasyDel.reinforcement_learning.trainer.partitioner_config.PartitionerConfig">PartitionerConfig</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[PartitionerConfig]: Specify the partitioner configuration</p>
            </div>
          </td>
          <td>
                <code><span title="lib.python.EasyDel.reinforcement_learning.trainer.partitioner_config.PartitionerConfig">PartitionerConfig</span>()</code>
          </td>
        </tr>
        <tr>
          <td><code>beta</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>float: Control the strength of the regularization term</p>
            </div>
          </td>
          <td>
                <code>0.1</code>
          </td>
        </tr>
        <tr>
          <td><code>label_smoothing</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>float: Smooth the labels</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>loss_type</code></td>
          <td>
                <code><span title="typing.Literal">Literal</span>[&#39;sigmoid&#39;, &#39;hinge&#39;, &#39;ipo&#39;, &#39;kto&#39;]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Literal["sigmoid", "hinge", "ipo", "kto"] : Determine the loss function used</p>
            </div>
          </td>
          <td>
                <code>&#39;sigmoid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>arguments</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lib.python.EasyDel.trainer.training_configurations.TrainArguments" href="../generated-trainer-training_configurations/#lib.python.EasyDel.trainer.training_configurations.TrainArguments">TrainArguments</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>TrainArguments: Pass the arguments to the trainer</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>label_pad_token_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>int: Pad the labels</p>
            </div>
          </td>
          <td>
                <code>-100</code>
          </td>
        </tr>
        <tr>
          <td><code>padding_value</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>int: Specify the value that is used for padding</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>truncation_mode</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>str: Truncate the input text</p>
            </div>
          </td>
          <td>
                <code>&#39;keep_end&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>train_dataset</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="datasets.Dataset">Dataset</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Dataset]: Load the training dataset</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>eval_dataset</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="datasets.Dataset">Dataset</span>, <span title="typing.Dict">Dict</span>[str, <span title="datasets.Dataset">Dataset</span>]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Union[Dataset, Dict[str, Dataset]]] : Pass the evaluation dataset to the trainer</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>tokenizer</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="transformers.PreTrainedTokenizerBase">PreTrainedTokenizerBase</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[PreTrainedTokenizerBase]: Pass the tokenizer to the trainer</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_length</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[int]: Set the maximum length of the input sequence</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_prompt_length</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[int]: Set the maximum length of the prompt</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>max_target_length</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[int]: Truncate the target sequence</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>precompute_ref_log_probs</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Precompute the log probabilities of the reference model</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>model_init_kwarguments</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Dict]: Pass in the model_kwarguments to model for init process</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>ref_model_init_kwarguments</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Optional[Dict]: Pass the ref_model_init_kwarguments to ref_model for init process</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code></code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Set the padding value for the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_state</span><span class="p">:</span> <span class="n">EasyDelState</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_model_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EasyDelState</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">partitioner_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PartitionerConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">PartitionerConfig</span><span class="p">(),</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">label_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">loss_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span> <span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">arguments</span><span class="p">:</span> <span class="n">TrainArguments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">truncation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">eval_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PreTrainedTokenizerBase</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_prompt_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_target_length</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">precompute_ref_log_probs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">model_init_kwarguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ref_model_init_kwarguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">reference_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The __init__ function is called when the class is instantiated.</span>
<span class="sd">    It sets up the attributes of an object.</span>


<span class="sd">    :param self: Refer to the object itself</span>
<span class="sd">    :param model_state: EasyDelState | str: Pass the model state to the trainer</span>
<span class="sd">    :param ref_model_state: Optional[EasyDelState | str]: Pass the reference model state</span>
<span class="sd">    :param partitioner_config: Optional[PartitionerConfig]: Specify the partitioner configuration</span>
<span class="sd">    :param beta: float: Control the strength of the regularization term</span>
<span class="sd">    :param label_smoothing: float: Smooth the labels</span>
<span class="sd">    :param loss_type: Literal[&quot;sigmoid&quot;, &quot;hinge&quot;, &quot;ipo&quot;, &quot;kto&quot;] : Determine the loss function used</span>
<span class="sd">    :param arguments: TrainArguments: Pass the arguments to the trainer</span>
<span class="sd">    :param label_pad_token_id: int: Pad the labels</span>
<span class="sd">    :param padding_value: int: Specify the value that is used for padding</span>
<span class="sd">    :param truncation_mode: str: Truncate the input text</span>
<span class="sd">    :param train_dataset: Optional[Dataset]: Load the training dataset</span>
<span class="sd">    :param eval_dataset: Optional[Union[Dataset, Dict[str, Dataset]]] : Pass the evaluation dataset to the trainer</span>
<span class="sd">    :param tokenizer: Optional[PreTrainedTokenizerBase]: Pass the tokenizer to the trainer</span>
<span class="sd">    :param max_length: Optional[int]: Set the maximum length of the input sequence</span>
<span class="sd">    :param max_prompt_length: Optional[int]: Set the maximum length of the prompt</span>
<span class="sd">    :param max_target_length: Optional[int]: Truncate the target sequence</span>
<span class="sd">    :param precompute_ref_log_probs: bool: Precompute the log probabilities of the reference model</span>
<span class="sd">    :param model_init_kwarguments: Optional[Dict]: Pass in the model_kwarguments to model for init process</span>
<span class="sd">    :param ref_model_init_kwarguments: Optional[Dict]: Pass the ref_model_init_kwarguments to ref_model for init process</span>
<span class="sd">    :param : Set the padding value for the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">partitioner_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">partitioner_config</span> <span class="o">=</span> <span class="n">PartitionerConfig</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">partitioner_config</span> <span class="o">=</span> <span class="n">partitioner_config</span>
    <span class="k">assert</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;You Have to pass arguments that will be used for training but you have passed&quot;</span>
        <span class="s2">&quot;`arguments=None`&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arguments</span><span class="p">,</span> <span class="n">TrainArguments</span><span class="p">),</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;arguments type must be `TrainArguments` but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">model_init_kwarguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model_init_kwarguments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You passed model_kwarguments to the DPOTrainer. But your model is already instantiated.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ref_model_init_kwarguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ref_model_init_kwarguments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;You passed ref_model_kwarguments to the DPOTrainer. But your ref_model is already instantiated.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You passed a model_id to the DPOTrainer. This will automatically create an &quot;</span>
            <span class="s2">&quot;`AutoEasyDelModelForCausalLM` for you.&quot;</span>
        <span class="p">)</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">EasyDelState</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">model_state</span><span class="p">,</span>
            <span class="o">**</span><span class="n">model_init_kwarguments</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_model_state</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You passed a ref model_id to the DPOTrainer. This will automatically create an &quot;</span>
            <span class="s2">&quot;`AutoEasyDelModelForCausalLM`&quot;</span>
        <span class="p">)</span>
        <span class="n">ref_model_state</span> <span class="o">=</span> <span class="n">EasyDelState</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="n">ref_model_state</span><span class="p">,</span>
            <span class="o">**</span><span class="n">ref_model_init_kwarguments</span>
        <span class="p">)</span>

    <span class="n">data_collator</span> <span class="o">=</span> <span class="n">DPODataCollatorWithPadding</span><span class="p">(</span>
        <span class="n">pad_token_id</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">padding_value</span> <span class="o">=</span> <span class="n">padding_value</span> <span class="k">if</span> <span class="n">padding_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span> <span class="o">=</span> <span class="n">max_prompt_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">=</span> <span class="n">truncation_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_target_length</span> <span class="o">=</span> <span class="n">max_target_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="o">=</span> <span class="n">precompute_ref_log_probs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reference_free</span> <span class="o">=</span> <span class="n">reference_free</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_eval_ref_log_probs</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">loss_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label_smoothing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;You are using a loss type that does not support label smoothing. Ignoring label_smoothing parameter.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label_smoothing</span> <span class="o">=</span> <span class="n">label_smoothing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss_type</span> <span class="o">=</span> <span class="n">loss_type</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_stored_metrics</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">eval_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize_row</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hp_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deepspeed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">is_in_train</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span> <span class="o">=</span> <span class="n">data_collator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">eval_dataset</span> <span class="o">=</span> <span class="n">eval_dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span> <span class="o">=</span> <span class="n">ref_model_state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_state</span> <span class="o">=</span> <span class="n">model_state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_loggers_initialized</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">get_mesh</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span> <span class="o">=</span> <span class="n">create_concatenated_forward</span><span class="p">(</span>
        <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__repr__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The <strong>repr</strong> function is used to generate a string representation of an object.
This function should return a string that can be parsed by the Python interpreter
to recreate the object. The <strong>repr</strong> function is called when you use print() on an
object, or when you type its name in the REPL.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Refer to the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A string representation of the object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The __repr__ function is used to generate a string representation of an object.</span>
<span class="sd">    This function should return a string that can be parsed by the Python interpreter</span>
<span class="sd">    to recreate the object. The __repr__ function is called when you use print() on an</span>
<span class="sd">    object, or when you type its name in the REPL.</span>

<span class="sd">    :param self: Refer to the instance of the class</span>
<span class="sd">    :return: A string representation of the object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">repr_src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> : &quot;</span> <span class="o">+</span> <span class="n">v</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="n">repr_src</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">repr_src</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">350</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> : &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(...)&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">string</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.__str__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__str__</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The <strong>str</strong> function is called when you use the print function or when str() is used.
It should return a string representation of the object.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Refer to the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The object's string representation</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The __str__ function is called when you use the print function or when str() is used.</span>
<span class="sd">    It should return a string representation of the object.</span>

<span class="sd">    :param self: Refer to the instance of the class</span>
<span class="sd">    :return: The object&#39;s string representation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.build_tokenized_answer" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Llama tokenizer does satisfy <code>enc(a + b) = enc(a) + enc(b)</code>.
It does ensure <code>enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]</code>.</p>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">build_tokenized_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Llama tokenizer does satisfy `enc(a + b) = enc(a) + enc(b)`.</span>
<span class="sd">    It does ensure `enc(a + b) = enc(a) + enc(a + b)[len(enc(a)):]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">full_tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span> <span class="o">+</span> <span class="n">answer</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span>

    <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">):]</span>
    <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">):]</span>
    <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">)</span>
    <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">answer_input_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;i4&quot;</span><span class="p">)</span>
    <span class="n">full_concat_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">prompt_input_ids</span><span class="p">,</span>
            <span class="n">answer_input_ids</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Prepare input tokens for token by token comparison</span>
    <span class="n">full_input_ids</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_concat_input_ids</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and answer input ids should have the same length.&quot;</span><span class="p">)</span>

    <span class="n">response_token_ids_start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prompt_input_ids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">!=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]:</span>
        <span class="n">response_token_ids_start_idx</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">prompt_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>
    <span class="n">prompt_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][:</span><span class="n">response_token_ids_start_idx</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_input_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_attention_mask</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Prompt input ids and attention mask should have the same length.&quot;</span><span class="p">)</span>

    <span class="n">answer_input_ids</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>
    <span class="n">answer_attention_mask</span> <span class="o">=</span> <span class="n">full_tokenized</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">][</span><span class="n">response_token_ids_start_idx</span><span class="p">:]</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">prompt_input_ids</span><span class="o">=</span><span class="n">prompt_input_ids</span><span class="p">,</span>
        <span class="n">prompt_attention_mask</span><span class="o">=</span><span class="n">prompt_attention_mask</span><span class="p">,</span>
        <span class="n">input_ids</span><span class="o">=</span><span class="n">answer_input_ids</span><span class="p">,</span>
        <span class="n">attention_mask</span><span class="o">=</span><span class="n">answer_attention_mask</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.compute_reference_log_probs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">compute_reference_log_probs</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">padded_batch</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.</p>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_reference_log_probs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">EasyDelState</span><span class="p">,</span>
        <span class="n">padded_batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes log probabilities of the reference model for a single padded batch of a DPO specific dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">padded_batch</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
            <span class="n">_</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concatenated_forward</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_model_state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">batch</span><span class="o">=</span><span class="n">padded_batch</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">reference_chosen_log_probs</span><span class="p">,</span> <span class="n">reference_rejected_log_probs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.eval" class="doc doc-heading">
          <code class="highlight language-python"><span class="nb">eval</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Process is Under Progress ...</p>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process is Under Progress ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO : Finish Eval Step</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_mesh" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_mesh</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The get_mesh function returns the mesh of a given instance of the class.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Bind the method to an object</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="jax.sharding.Mesh">Mesh</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The mesh of the device</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">Mesh</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The get_mesh function returns the mesh of a given instance of the class.</span>

<span class="sd">    :param self: Bind the method to an object</span>
<span class="sd">    :return: The mesh of the device</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.get_train_dataloader" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_train_dataloader</span><span class="p">()</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the training [<code>~torch.utils.data.DataLoader</code>].</p>
<p>Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute <code>ref_log_probs</code>.</p>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_train_dataloader</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the training [`~torch.utils.data.DataLoader`].</span>

<span class="sd">    Subclass of transformers.src.transformers.trainer.get_train_dataloader to precompute `ref_log_probs`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">precompute_ref_log_probs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span><span class="p">:</span>
        <span class="n">dataloader_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">total_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;collate_fn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_collator</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_num_workers</span><span class="p">,</span>
            <span class="s2">&quot;pin_memory&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">dataloader_pin_memory</span><span class="p">,</span>
            <span class="s2">&quot;shuffle&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">dataloader_params</span><span class="p">)</span>

        <span class="n">reference_chosen_log_probs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reference_rejected_log_probs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">padded_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterable</span><span class="o">=</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Train dataset reference log probs&quot;</span><span class="p">):</span>
            <span class="n">reference_chosen_logp</span><span class="p">,</span> <span class="n">reference_rejected_logp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reference_log_probs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_state</span><span class="p">,</span>
                <span class="n">padded_batch</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">reference_chosen_log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_chosen_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="n">reference_rejected_log_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reference_rejected_logp</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="n">all_reference_chosen_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reference_chosen_log_probs</span><span class="p">)</span>
        <span class="n">all_reference_rejected_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reference_rejected_log_probs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_chosen_log_probs&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_chosen_log_probs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reference_rejected_log_probs&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">all_reference_rejected_log_probs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_precomputed_train_ref_log_probs</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_train_dataloader</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.DPOTrainer.tokenize_row" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tokenize_row</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The tokenize_row function is responsible for taking a single row of data and converting it into the format that
the model expects. This includes:
- Tokenizing the text (using HuggingFace's tokenizer)
- Padding/truncating sequences to a fixed length (if necessary)
- Creating attention masks, which tell the model which tokens are padding and which aren't.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>self</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Represent the instance of the class</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>feature</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pass in the data from the dataset</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>state</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lib.python.EasyDel.etils.easystate.EasyDelState" href="../generated-etils-easystate/#lib.python.EasyDel.etils.easystate.EasyDelState">EasyDelState</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>EasyDelState: Keep track of the state of the tokenizer</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of the following keys</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tokenize_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">EasyDelState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tokenize_row function is responsible for taking a single row of data and converting it into the format that</span>
<span class="sd">    the model expects. This includes:</span>
<span class="sd">    - Tokenizing the text (using HuggingFace&#39;s tokenizer)</span>
<span class="sd">    - Padding/truncating sequences to a fixed length (if necessary)</span>
<span class="sd">    - Creating attention masks, which tell the model which tokens are padding and which aren&#39;t.</span>

<span class="sd">    :param self: Represent the instance of the class</span>
<span class="sd">    :param feature: Pass in the data from the dataset</span>
<span class="sd">    :param state: EasyDelState: Keep track of the state of the tokenizer</span>
<span class="sd">    :return: A dictionary of the following keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;prompt&quot;</span><span class="p">]</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;chosen&quot;</span><span class="p">]</span>
    <span class="n">rejected</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;rejected&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2"> , </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_tokens</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chosen</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chosen should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">chosen</span><span class="p">)</span><span class="si">}</span><span class="s2"> , </span><span class="si">{</span><span class="n">chosen</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">chosen_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">chosen</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rejected</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejected should be an str but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">rejected_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tokenized_answer</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>

    <span class="c1"># add BOS token to head of prompt</span>
    <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
    <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
    <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>

    <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">prompt_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
    <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>
    <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span>

    <span class="c1"># add EOS token to end of answer</span>
    <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
    <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
    <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">longer_response_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]))</span>

    <span class="c1"># if combined sequence is too long, truncate the prompt</span>
    <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">,</span> <span class="n">prompt_tokens</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_start&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                    <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span> <span class="o">==</span> <span class="s2">&quot;keep_end&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]:</span>
                    <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown truncation mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">truncation_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># if that&#39;s still too long, truncate the response</span>
    <span class="k">for</span> <span class="n">answer_tokens</span> <span class="ow">in</span> <span class="p">[</span><span class="n">chosen_tokens</span><span class="p">,</span> <span class="n">rejected_tokens</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">longer_response_length</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]:</span>
                <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">]</span>

    <span class="c1"># Create labels</span>
    <span class="n">chosen_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">chosen_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">rejected_sequence_tokens</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;prompt_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rejected_tokens</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
    <span class="n">chosen_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
                                                                                 <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">chosen_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">][:]</span>
    <span class="n">rejected_sequence_tokens</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span>
                                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">label_pad_token_id</span>
                                                                                     <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
        <span class="n">rejected_tokens</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">tokens_</span> <span class="ow">in</span> <span class="p">{</span>
        <span class="s2">&quot;chosen_&quot;</span><span class="p">:</span> <span class="n">chosen_sequence_tokens</span><span class="p">,</span>
        <span class="s2">&quot;rejected_&quot;</span><span class="p">:</span> <span class="n">rejected_sequence_tokens</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">prompt_tokens</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">type_key</span><span class="p">,</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">tokens_</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">type_key</span> <span class="o">==</span> <span class="s2">&quot;token_type_ids&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">batch</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}{</span><span class="n">type_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>

    <span class="k">return</span> <span class="n">batch</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>



<div class="doc doc-object doc-function">



<h2 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.concatenated_inputs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">concatenated_inputs</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The concatenated_inputs function takes a batch of chosen and rejected examples,
and concatenates them together. This is useful for training the model to predict whether     an example was chosen by the human annotator. The function also pads all inputs to
the same length as the longest input in that batch.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Union">Union</span>[<span title="typing.List">List</span>, <span title="chex.Array">Array</span>]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Dict[str,Union[List,chex.Array]]: Pass the batch of data into the function, Allow for the batch to be a list of arrays or just an array, Specify the type of data that is being passed in</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>is_encoder_decoder</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Determine whether the model is an encoder-decoder model</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>label_pad_token_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>int: Pad the labels with a value of -100</p>
            </div>
          </td>
          <td>
                <code>-100</code>
          </td>
        </tr>
        <tr>
          <td><code>padding_value</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>int: Pad the input_ids and attention_mask arrays to the same length</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="chex.Array">Array</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of the concatenated inputs</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">concatenated_inputs</span><span class="p">(</span>
        <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]],</span>
        <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">padding_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The concatenated_inputs function takes a batch of chosen and rejected examples,</span>
<span class="sd">    and concatenates them together. This is useful for training the model to predict whether     an example was chosen by the human annotator. The function also pads all inputs to</span>
<span class="sd">    the same length as the longest input in that batch.</span>

<span class="sd">    :param batch: Dict[str,Union[List,chex.Array]]: Pass the batch of data into the function,</span>
<span class="sd">    Allow for the batch to be a list of arrays or just an array,</span>
<span class="sd">     Specify the type of data that is being passed in</span>
<span class="sd">    :param is_encoder_decoder: bool: Determine whether the model is an encoder-decoder model</span>
<span class="sd">    :param label_pad_token_id: int: Pad the labels with a value of -100</span>
<span class="sd">    :param padding_value: int: Pad the input_ids and attention_mask arrays to the same length</span>
<span class="sd">    :return: A dictionary of the concatenated inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;rejected_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find pad_value [Dataset Issue]&quot;</span><span class="p">)</span>
            <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;chosen&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;labels&quot;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">label_pad_token_id</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_input_ids&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="n">padding_value</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_attention_mask&quot;</span><span class="p">):</span>
                <span class="n">pad_value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t find pad_value [Dataset Issue]&quot;</span><span class="p">)</span>
            <span class="n">concatenated_key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rejected&quot;</span><span class="p">,</span> <span class="s2">&quot;concatenated&quot;</span><span class="p">)</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">concatenated_batch</span><span class="p">[</span><span class="n">concatenated_key</span><span class="p">],</span>
                    <span class="n">pad_to_length</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompt_attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">concatenated_batch</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_concatenated_forward" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_concatenated_forward</span><span class="p">(</span><span class="n">is_encoder_decoder</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="p">,</span> <span class="n">padding_value</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The create_concatenated_forward function is a helper function that creates a forward pass function for the
model. The forward pass function takes in an apply_fn, which is the model's apply_fn, and runs it on concatenated
inputs. It returns chosen log probs, rejected log probs, chosen logits and rejected logits.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>is_encoder_decoder</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Determine whether the model is an encoder-decoder model or not</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>label_pad_token_id</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pad the labels to the same length</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>padding_value</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pad the inputs to the same length</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A function that takes in a apply_fn, params and a batch of inputs,</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_concatenated_forward</span><span class="p">(</span>
        <span class="n">is_encoder_decoder</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="n">padding_value</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The create_concatenated_forward function is a helper function that creates a forward pass function for the</span>
<span class="sd">    model. The forward pass function takes in an apply_fn, which is the model&#39;s apply_fn, and runs it on concatenated</span>
<span class="sd">    inputs. It returns chosen log probs, rejected log probs, chosen logits and rejected logits.</span>

<span class="sd">    :param is_encoder_decoder: Determine whether the model is an encoder-decoder model or not</span>
<span class="sd">    :param label_pad_token_id: Pad the labels to the same length</span>
<span class="sd">    :param padding_value: Pad the inputs to the same length</span>
<span class="sd">    :return: A function that takes in a apply_fn, params and a batch of inputs,</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">concatenated_forward</span><span class="p">(</span>
            <span class="n">apply_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]]</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The concatenated_forward function is used to compute the log-probabilities of both chosen and rejected labels.</span>

<span class="sd">        :param apply_fn: Callable: Pass in the model function</span>
<span class="sd">        :param params: dict | flax.core.FrozenDict: Pass the model parameters to the function</span>
<span class="sd">        :param batch: Dict[str, Union[List, chex.Array]] : Pass the batch of data to the concatenated_forward function</span>
<span class="sd">        :return: The log_probs of the chosen and rejected labels, as well as their corresponding logits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">concatenated_batch</span> <span class="o">=</span> <span class="n">concatenated_inputs</span><span class="p">(</span>
            <span class="n">batch</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span><span class="p">,</span>
            <span class="n">padding_value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">len_chosen</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;chosen_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
                <span class="s2">&quot;decoder_input_ids&quot;</span><span class="p">:</span> <span class="n">concatenated_batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;concatenated_decoder_input_ids&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">is_encoder_decoder</span>
            <span class="k">else</span> <span class="p">{}</span>
        <span class="p">)</span>
        <span class="n">all_logits</span> <span class="o">=</span> <span class="n">apply_fn</span><span class="p">(</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_input_ids&quot;</span><span class="p">],</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_attention_mask&quot;</span><span class="p">],</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="o">**</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">logits</span>

        <span class="n">all_log_probs</span> <span class="o">=</span> <span class="n">get_batch_log_probs</span><span class="p">(</span>
            <span class="n">all_logits</span><span class="p">,</span>
            <span class="n">concatenated_batch</span><span class="p">[</span><span class="s2">&quot;concatenated_labels&quot;</span><span class="p">],</span>
            <span class="n">average_log_prob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="n">is_encoder_decoder</span><span class="p">,</span>
            <span class="n">label_pad_token_id</span><span class="o">=</span><span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">chosen_log_probs</span> <span class="o">=</span> <span class="n">all_log_probs</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
        <span class="n">rejected_log_probs</span> <span class="o">=</span> <span class="n">all_log_probs</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

        <span class="n">chosen_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[:</span><span class="n">len_chosen</span><span class="p">]</span>
        <span class="n">rejected_logits</span> <span class="o">=</span> <span class="n">all_logits</span><span class="p">[</span><span class="n">len_chosen</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">chosen_log_probs</span><span class="p">,</span> <span class="n">rejected_log_probs</span><span class="p">,</span> <span class="n">chosen_logits</span><span class="p">,</span> <span class="n">rejected_logits</span>

    <span class="k">return</span> <span class="n">concatenated_forward</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.create_dpo_train_function" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_dpo_train_function</span><span class="p">(</span><span class="n">concatenated_forward</span><span class="p">,</span> <span class="n">ref_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label_smoothing</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">loss_type</span><span class="o">=</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">,</span> <span class="n">reference_free</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The create_dpo_train_function function is a helper function that creates the DPO training step.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>concatenated_forward</code></td>
          <td>
                <code><span title="typing.Callable">Callable</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Callable: Define the forward pass of the model</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>ref_state</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="lib.python.EasyDel.etils.easystate.EasyDelState" href="../generated-etils-easystate/#lib.python.EasyDel.etils.easystate.EasyDelState">EasyDelState</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>EasyDelState: Specify the reference policy</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>beta</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>float: Scale the logits</p>
            </div>
          </td>
          <td>
                <code>0.1</code>
          </td>
        </tr>
        <tr>
          <td><code>label_smoothing</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>float: Smooth the labels</p>
            </div>
          </td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>loss_type</code></td>
          <td>
                <code><span title="typing.Literal">Literal</span>[&#39;sigmoid&#39;, &#39;hinge&#39;, &#39;ipo&#39;, &#39;kto&#39;]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Literal["sigmoid", "hinge", "ipo", "kto"]: Determine the loss function</p>
            </div>
          </td>
          <td>
                <code>&#39;sigmoid&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>reference_free</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Indicate whether the reference policy is used or not</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A function that takes in a state and a batch</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_dpo_train_function</span><span class="p">(</span>
        <span class="n">concatenated_forward</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">ref_state</span><span class="p">:</span> <span class="n">EasyDelState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">label_smoothing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">loss_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span> <span class="s2">&quot;hinge&quot;</span><span class="p">,</span> <span class="s2">&quot;ipo&quot;</span><span class="p">,</span> <span class="s2">&quot;kto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="n">reference_free</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The create_dpo_train_function function is a helper function that creates the DPO training step.</span>

<span class="sd">    :param concatenated_forward: Callable: Define the forward pass of the model</span>
<span class="sd">    :param ref_state: EasyDelState: Specify the reference policy</span>
<span class="sd">    :param beta: float: Scale the logits</span>
<span class="sd">    :param label_smoothing: float: Smooth the labels</span>
<span class="sd">    :param loss_type:  Literal[&quot;sigmoid&quot;, &quot;hinge&quot;, &quot;ipo&quot;, &quot;kto&quot;]: Determine the loss function</span>
<span class="sd">    :param reference_free: bool: Indicate whether the reference policy is used or not</span>
<span class="sd">    :return: A function that takes in a state and a batch</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_sigmoid_dpo_loss</span><span class="p">(</span>
            <span class="n">logits</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">policy_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">policy_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># IGNORED</span>
    <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The _sigmoid_dpo_loss function is a helper function for the sigmoid_dpo_loss</span>
<span class="sd">            function. It computes the loss of each example in a batch, given its logits</span>
<span class="sd">            and (optionally) its chosen/rejected log probabilities under both policies.</span>

<span class="sd">        :param logits: chex.Array: Compute the loss</span>
<span class="sd">        :param policy_chosen_log_probs: chex.Array: Calculate the policy loss</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    reference_chosen_log_probs: chex.Array: Compute the loss for the reference policy</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    policy_rejected_log_probs: chex.Array: Calculate the loss for the rejected samples</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    reference_rejected_log_probs: chex.Array: Calculate the loss of rejected samples</span>
<span class="sd">        :return: an array represent loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">log_sigmoid</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">label_smoothing</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">log_sigmoid</span><span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span> <span class="o">*</span> <span class="n">label_smoothing</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">losses</span>

    <span class="k">def</span> <span class="nf">_hinge_dpo_loss</span><span class="p">(</span>
            <span class="n">logits</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">policy_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">policy_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># IGNORED</span>
    <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The _hinge_dpo_loss function is a helper function that computes the loss for DPO.</span>

<span class="sd">        :param logits: chex.Array: Calculate the hinge loss</span>
<span class="sd">        :param policy_chosen_log_probs: chex.Array: Compute the policy loss</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    reference_chosen_log_probs: chex.Array: Compute the loss</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    policy_rejected_log_probs: chex.Array: Calculate the loss</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    reference_rejected_log_probs: chex.Array  # IGNORED: Calculate the loss</span>
<span class="sd">        :return: an array represent The hinge loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">logits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ipo_dpo_loss</span><span class="p">(</span>
            <span class="n">logits</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">policy_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">policy_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># IGNORED</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         The _ipo_dpo_loss function is a helper function that calculates the loss for</span>
<span class="sd">         the IPO-DPO algorithm. It takes in the logits, policy_chosen_log_probs,</span>
<span class="sd">         reference_chosen_log_probs, policy rejected log probs and reference rejected</span>
<span class="sd">         log probs as inputs. The output of this function is used to calculate the loss</span>
<span class="sd">         for each batch of data.</span>

<span class="sd">         :param logits: chex.Array: Calculate the loss</span>
<span class="sd">         :param policy_chosen_log_probs: chex.Array: Compute the</span>
<span class="sd">         :param # IGNORED</span>
<span class="sd">                     reference_chosen_log_probs: chex.Array: Compute the loss</span>
<span class="sd">         :param # IGNORED</span>
<span class="sd">                     policy_rejected_log_probs: chex.Array: Calculate the probability of rejecting a policy</span>
<span class="sd">         :param # IGNORED</span>
<span class="sd">                     reference_rejected_log_probs: chex.Array  # IGNORED: Make sure that the function</span>
<span class="sd">         :return: an array represent loss</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beta</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_kto_pair_dpo_loss</span><span class="p">(</span>
            <span class="n">logits</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>  <span class="c1"># IGNORED</span>
            <span class="n">policy_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">reference_chosen_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">policy_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
            <span class="n">reference_rejected_log_probs</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The _kto_pair_dpo_loss function is a helper function that computes the loss for</span>
<span class="sd">        a single pair of trajectories. It takes in two sets of log probabilities, one from</span>
<span class="sd">        the policy and one from the reference distribution. The first set are the log</span>
<span class="sd">        probabilities for actions taken by each agent in a trajectory, while the second set</span>
<span class="sd">        are those for actions not taken by each agent (i.e., rejected). The function then</span>
<span class="sd">        computes KL divergences between these two sets of distributions and uses them to compute losses.</span>

<span class="sd">        :param logits: chex.Array: Calculate the log_probs</span>
<span class="sd">        :param # IGNORED</span>
<span class="sd">                    policy_chosen_log_probs: chex.Array: Calculate the chosen_kl</span>
<span class="sd">        :param reference_chosen_log_probs: chex.Array: Calculate the chosen_kl</span>
<span class="sd">        :param policy_rejected_log_probs: chex.Array: Calculate the rejected_kl variable</span>
<span class="sd">        :param reference_rejected_log_probs: chex.Array: Calculate the rejected_kl variable</span>
<span class="sd">        :return: an array represent loss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chosen_kl</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">policy_chosen_log_probs</span> <span class="o">-</span> <span class="n">reference_chosen_log_probs</span><span class="p">),</span>
            <span class="nb">max</span><span class="o">=</span><span class="mf">1e9</span>
        <span class="p">)</span>
        <span class="n">rejected_kl</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span>
            <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">policy_rejected_log_probs</span> <span class="o">-</span> <span class="n">reference_rejected_log_probs</span><span class="p">),</span>
            <span class="nb">max</span><span class="o">=</span><span class="mf">1e9</span>
        <span class="p">)</span>

        <span class="n">chosen_log_ratios</span> <span class="o">=</span> <span class="n">policy_chosen_log_probs</span> <span class="o">-</span> <span class="n">reference_chosen_log_probs</span>
        <span class="n">rejected_log_ratios</span> <span class="o">=</span> <span class="n">policy_rejected_log_probs</span> <span class="o">-</span> <span class="n">reference_rejected_log_probs</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_log_ratios</span> <span class="o">-</span> <span class="n">rejected_kl</span><span class="p">)),</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">chosen_kl</span> <span class="o">-</span> <span class="n">rejected_log_ratios</span><span class="p">)),</span>
            <span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">losses</span>

    <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">:</span>
        <span class="n">_loss_func</span> <span class="o">=</span> <span class="n">_sigmoid_dpo_loss</span>
    <span class="k">elif</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;hinge&quot;</span><span class="p">:</span>
        <span class="n">_loss_func</span> <span class="o">=</span> <span class="n">_hinge_dpo_loss</span>
    <span class="k">elif</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;ipo&quot;</span><span class="p">:</span>
        <span class="n">_loss_func</span> <span class="o">=</span> <span class="n">_ipo_dpo_loss</span>
    <span class="k">elif</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="s2">&quot;kto_pair&quot;</span><span class="p">:</span>
        <span class="n">_loss_func</span> <span class="o">=</span> <span class="n">_kto_pair_dpo_loss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;UnKnown loss_type </span><span class="si">{</span><span class="n">loss_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dpo_step</span><span class="p">(</span>
            <span class="n">state</span><span class="p">:</span> <span class="n">EasyDelState</span><span class="p">,</span>
            <span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EasyDelState</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The dpo_step function is the core of DPO. It takes a state and a batch,</span>
<span class="sd">        and returns an updated state. The update is done by calculating the loss</span>
<span class="sd">        for each example in the batch, then taking its gradient with respect to</span>
<span class="sd">        the parameters of the policy network (which are stored in `state`). This</span>
<span class="sd">        gradient is then used to update `state`.</span>

<span class="sd">        :param state: EasyDelState: Store the parameters of the model</span>
<span class="sd">        :param batch: dict: Pass the data to the model</span>
<span class="sd">        :return: A new state, which is a collection of the parameters and apply_fn</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">calculate_loss</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">flax</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">FrozenDict</span><span class="p">):</span>
            <span class="p">(</span>
                <span class="n">policy_chosen_log_probs</span><span class="p">,</span>
                <span class="n">policy_rejected_log_probs</span><span class="p">,</span>
                <span class="n">policy_chosen_logits</span><span class="p">,</span>
                <span class="n">policy_rejected_logits</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">concatenated_forward</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">batch</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;reference_chosen_log_probs&quot;</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">and</span> <span class="s2">&quot;reference_rejected_log_probs&quot;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                <span class="n">reference_chosen_log_probs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_chosen_log_probs&quot;</span><span class="p">]</span>
                <span class="n">reference_rejected_log_probs</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reference_rejected_log_probs&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
                        <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">concatenated_forward</span><span class="p">(</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
                        <span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                        <span class="n">batch</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span>
                        <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
                        <span class="n">reference_rejected_log_probs</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                        <span class="n">_</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">=</span> <span class="n">concatenated_forward</span><span class="p">(</span>
                        <span class="n">ref_state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">,</span>
                        <span class="n">ref_state</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                        <span class="n">batch</span>
                    <span class="p">)</span>

            <span class="n">pi_log_ratios</span> <span class="o">=</span> <span class="n">policy_chosen_log_probs</span> <span class="o">-</span> <span class="n">policy_rejected_log_probs</span>

            <span class="k">if</span> <span class="n">reference_free</span><span class="p">:</span>
                <span class="n">ref_log_ratios</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_log_ratios</span> <span class="o">=</span> <span class="n">reference_chosen_log_probs</span> <span class="o">-</span> <span class="n">reference_rejected_log_probs</span>

            <span class="n">logits</span> <span class="o">=</span> <span class="n">pi_log_ratios</span> <span class="o">-</span> <span class="n">ref_log_ratios</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="n">_loss_func</span><span class="p">(</span>
                <span class="n">logits</span><span class="p">,</span>
                <span class="n">policy_chosen_log_probs</span><span class="p">,</span>
                <span class="n">reference_chosen_log_probs</span><span class="p">,</span>
                <span class="n">policy_rejected_log_probs</span><span class="p">,</span>
                <span class="n">reference_rejected_log_probs</span>
            <span class="p">)</span>
            <span class="n">chosen_rewards</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">beta</span>
                    <span class="o">*</span> <span class="p">(</span>
                            <span class="n">policy_chosen_log_probs</span> <span class="o">-</span> <span class="n">reference_chosen_log_probs</span>
                    <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">rejected_rewards</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">beta</span>
                    <span class="o">*</span> <span class="p">(</span>
                            <span class="n">policy_rejected_log_probs</span>
                            <span class="o">-</span> <span class="n">reference_rejected_log_probs</span>
                    <span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">losses</span><span class="p">,</span> <span class="n">chosen_rewards</span><span class="p">,</span> <span class="n">rejected_rewards</span>

        <span class="n">grad_fn</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">calculate_loss</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">__loss</span><span class="p">,</span> <span class="n">__chosen_rewards</span><span class="p">,</span> <span class="n">__rejected_rewards</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">grad_fn</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">return</span> <span class="n">dpo_step</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="lib.python.EasyDel.reinforcement_learning.trainer.dpo_trainer.get_batch_log_probs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_batch_log_probs</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">average_log_prob</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label_pad_token_id</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span> <span class="n">is_encoder_decoder</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The get_batch_log_probs function computes the log probability of a batch of sequences.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>logits</code></td>
          <td>
                <code><span title="chex.Array">Array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>chex.Array: Compute the log_softmax of the input</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>labels</code></td>
          <td>
                <code><span title="chex.Array">Array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>chex.Array: Mask the logits</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>average_log_prob</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Determine whether to average the log prob over the sequence length</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code>label_pad_token_id</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>int: Mask out the padding tokens in the labels</p>
            </div>
          </td>
          <td>
                <code>-100</code>
          </td>
        </tr>
        <tr>
          <td><code>is_encoder_decoder</code></td>
          <td>
                <code>bool</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>bool: Indicate whether the model is an encoder-decoder model</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr>
          <td><code></code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Determine whether to average the log probability over all tokens or not</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="chex.Array">Array</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The log probability of the labels given the logits</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>lib/python/EasyDel/reinforcement_learning/trainer/dpo_trainer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_batch_log_probs</span><span class="p">(</span>
        <span class="n">logits</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
        <span class="n">average_log_prob</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">label_pad_token_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">is_encoder_decoder</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The get_batch_log_probs function computes the log probability of a batch of sequences.</span>

<span class="sd">    :param logits: chex.Array: Compute the log_softmax of the input</span>
<span class="sd">    :param labels: chex.Array: Mask the logits</span>
<span class="sd">    :param average_log_prob: bool: Determine whether to average the log prob over the sequence length</span>
<span class="sd">    :param label_pad_token_id: int: Mask out the padding tokens in the labels</span>
<span class="sd">    :param is_encoder_decoder: bool: Indicate whether the model is an encoder-decoder model</span>
<span class="sd">    :param : Determine whether to average the log probability over all tokens or not</span>
<span class="sd">    :return: The log probability of the labels given the logits</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sudo code</span>
    <span class="c1"># (per_token_log_probs * loss_mask).sum(-1)</span>
    <span class="c1"># or</span>
    <span class="c1"># (per_token_log_probs * loss_mask).sum(-1) / loss_mask.sum(-1)</span>

    <span class="k">if</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logits (batch and sequence length dim) and labels must have the same shape.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_encoder_decoder</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="n">batch</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">loss_mask</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">!=</span> <span class="n">label_pad_token_id</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">labels</span> <span class="o">==</span> <span class="n">label_pad_token_id</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">labels</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
        <span class="n">labels</span>
    <span class="p">)</span>
    <span class="n">logits_log_s</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span>
        <span class="n">logits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">per_token_log_probs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">take_along_axis</span><span class="p">(</span>
        <span class="n">logits_log_s</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="n">labels</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">average_log_prob</span><span class="p">:</span>
        <span class="n">log_prob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">per_token_log_probs</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_prob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">per_token_log_probs</span> <span class="o">*</span> <span class="n">loss_mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log_prob</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Erfan Zare Chavoshi-EasyDel
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.caa56a14.min.js"></script>
      
    
  </body>
</html>